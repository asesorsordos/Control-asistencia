
<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia a Cultos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style type="text/tailwindcss">
        @layer utilities {
            .dark {
                --color-bg-primary: #1a202c;
                --color-bg-secondary: #2d3748;
                --color-text-primary: #f7fafc;
                --color-text-secondary: #e2e8f0;
                --color-accent: #81e6d9;
            }
            .light {
                --color-bg-primary: #ffffff;
                --color-bg-secondary: #edf2f7;
                --color-text-primary: #2d3748;
                --color-text-secondary: #4a5568;
                --color-accent: #4299e1;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--color-bg-primary)',
                        secondary: 'var(--color-bg-secondary)',
                        txtprimary: 'var(--color-text-primary)',
                        txtsecondary: 'var(--color-text-secondary)',
                        accent: 'var(--color-accent)',
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen bg-primary text-txtprimary transition-colors duration-300">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-accent">
                <i class="fa-solid fa-hotel"></i>
                Control de Asistencia
            </h1>
            <div>
                <button id="themeToggle" class="p-2 rounded-full bg-secondary hover:bg-accent hover:text-primary transition">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </header>

        <!-- Main Form -->
        <main class="bg-secondary rounded-lg shadow-xl p-6 mb-8">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Service Type and Date -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-txtsecondary mb-2">Tipo de Servicio</label>
                        <select id="serviceType" class="w-full p-3 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                            <option value="">Seleccionar...</option>
                            <option value="Escuela Dominical">Escuela Dominical</option>
                            <option value="Culto Evangelístico">Culto Evangelístico</option>
                            <option value="Culto de Oración">Culto de Oración</option>
                            <option value="Culto de Dorcas">Culto de Dorcas</option>
                            <option value="Culto de Caballeros">Culto de Caballeros</option>
                            <option value="Culto de Jóvenes">Culto de Jóvenes</option>
                            <option value="Culto Acción de Gracias">Culto Acción de Gracias</option>
                            <option value="Culto música">Culto Música</option>
                            <option value="Culto Campaña">Culto Campaña</option>
                            <option value="Culto Especial">Culto Especial</option>
                            <option value="Culto Misionero (Día)">Culto Misionero (Día)</option>
                            <option value="Culto Misionero (Noche)">Culto Misionero (Noche)</option>
                            <option value="Confraternidad Dorcas (Mitad de Año)">Confraternidad Dorcas (Mitad de Año)</option>
                            <option value="Confraternidad Dorcas (Fin de Año)">Confraternidad Dorcas (Fin de Año)</option>
                            <option value="Confraternidad Jóvenes (Mitad de Año)">Confraternidad Jóvenes (Mitad de Año)</option>
                            <option value="Confraternidad Jóvenes (Fin de Año)">Confraternidad Jóvenes (Fin de Año)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-txtsecondary mb-2">Fecha</label>
                        <input type="date" id="serviceDate" class="w-full p-3 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-txtsecondary mb-2">Quién dirigió</label>
                        <input type="text" id="serviceLeader" class="w-full p-3 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-txtsecondary mb-2">Quién predicó</label>
                        <input type="text" id="servicePreacher" class="w-full p-3 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-txtsecondary mb-2">Ofrenda ($)</label>
                        <input type="number" id="serviceOffering" class="w-full p-3 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none" min="0" step="100">
                    </div>
                </div>
                
                <!-- Attendance -->
                <div class="space-y-4">
                    <h3 class="text-xl font-semibold mb-4">Asistencia</h3>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-txtsecondary">Hermanos</label>
                        <div class="flex items-center">
                            <button class="decrement bg-primary w-8 h-8 rounded-l-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="brothers">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="brothers" class="bg-primary h-8 w-16 text-center border-t border-b border-gray-600" value="0" min="0">
                            <button class="increment bg-primary w-8 h-8 rounded-r-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="brothers">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-txtsecondary">Hermanas</label>
                        <div class="flex items-center">
                            <button class="decrement bg-primary w-8 h-8 rounded-l-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="sisters">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="sisters" class="bg-primary h-8 w-16 text-center border-t border-b border-gray-600" value="0" min="0">
                            <button class="increment bg-primary w-8 h-8 rounded-r-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="sisters">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-txtsecondary">Visitas</label>
                        <div class="flex items-center">
                            <button class="decrement bg-primary w-8 h-8 rounded-l-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="visitors">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="visitors" class="bg-primary h-8 w-16 text-center border-t border-b border-gray-600" value="0" min="0">
                            <button class="increment bg-primary w-8 h-8 rounded-r-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="visitors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label class="text-txtsecondary">Niños</label>
                        <div class="flex items-center">
                            <button class="decrement bg-primary w-8 h-8 rounded-l-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="children">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="children" class="bg-primary h-8 w-16 text-center border-t border-b border-gray-600" value="0" min="0">
                            <button class="increment bg-primary w-8 h-8 rounded-r-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="children">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <label class="text-txtsecondary">Hermanos Visitantes</label>
                        <div class="flex items-center">
                            <button class="decrement bg-primary w-8 h-8 rounded-l-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="visitingBrothers">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="visitingBrothers" class="bg-primary h-8 w-16 text-center border-t border-b border-gray-600" value="0" min="0">
                            <button class="increment bg-primary w-8 h-8 rounded-r-lg flex items-center justify-center hover:bg-accent hover:text-primary" data-target="visitingBrothers">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-primary rounded-lg">
                        <h4 class="font-medium text-accent mb-2">Resumen Total</h4>
                        <p class="flex justify-between">
                            <span>Total Asistentes:</span>
                            <span id="totalAttendees" class="font-bold">0</span>
                        </p>
                        <p class="flex justify-between">
                            <span>Ofrenda:</span>
                            <span id="totalOffering" class="font-bold">$0</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-4 mt-8">
                <button id="saveBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition">
                    <i class="fas fa-save"></i> Guardar
                </button>
                <button id="clearBtn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition">
                    <i class="fas fa-eraser"></i> Limpiar
                </button>
                <button id="newBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition">
                    <i class="fas fa-plus"></i> Nueva Toma
                </button>
            </div>
        </main>

        <!-- Records Section -->
        <section class="bg-secondary rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-accent">
                    <i class="fas fa-history mr-2"></i>
                    Registros Anteriores
                </h2>
                <div class="flex items-center gap-4">
                    <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center gap-2 transition text-sm">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                    <div class="relative">
                        <select id="filterRecords" class="p-2 rounded-lg bg-primary border border-gray-600 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                            <option value="all">Todos</option>
                            <option value="Escuela Dominical">Escuela Dominical</option>
                            <option value="Culto Evangelístico">Culto Evangelístico</option>
                            <option value="Culto de Oración">Culto de Oración</option>
                            <option value="Culto de Dorcas">Culto de Dorcas</option>
                            <option value="Culto de Caballeros">Culto de Caballeros</option>
                            <option value="Culto de Jóvenes">Culto de Jóvenes</option>
                            <option value="Culto Acción de Gracias">Culto Acción de Gracias</option>
                            <option value="Culto Campaña">Culto Campaña</option>
                            <option value="Culto Especial">Culto Especial</option>
                            <option value="Culto música">Culto Música</option>
                            <option value="Culto Misionero (Día)">Culto Misionero (Día)</option>
                            <option value="Culto Misionero (Noche)">Culto Misionero (Noche)</option>
                            <option value="Confraternidad Dorcas (Mitad de Año)">Confraternidad Dorcas (Mitad de Año)</option>
                            <option value="Confraternidad Dorcas (Fin de Año)">Confraternidad Dorcas (Fin de Año)</option>
                            <option value="Confraternidad Jóvenes (Mitad de Año)">Confraternidad Jóvenes (Mitad de Año)</option>
                            <option value="Confraternidad Jóvenes (Fin de Año)">Confraternidad Jóvenes (Fin de Año)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full bg-primary rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-accent text-primary">
                            <th class="py-3 px-4 text-left">Fecha</th>
                            <th class="py-3 px-4 text-left">Servicio</th>
                            <th class="py-3 px-4 text-left">Dirigió</th>
                            <th class="py-3 px-4 text-left">Predicó</th>
                            <th class="py-3 px-4 text-center">Hermanos</th>
                            <th class="py-3 px-4 text-center">Hermanas</th>
                            <th class="py-3 px-4 text-center">Visitas</th>
                            <th class="py-3 px-4 text-center">Niños</th>
                            <th class="py-3 px-4 text-center">Hnos. Visitantes</th>
                            <th class="py-3 px-4 text-center">Total</th>
                            <th class="py-3 px-4 text-center">Ofrenda</th>
                            <th class="py-3 px-4 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable" class="divide-y divide-gray-600">
                        <!-- Records will be inserted here dynamically -->
                        <tr>
                            <td colspan="12" class="py-4 text-center text-txtsecondary">No hay registros aún</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Stats Section -->
        <section class="mt-8 grid md:grid-cols-3 gap-6">
            <div class="bg-secondary rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-users text-accent"></i>
                    Asistencia Promedio
                </h3>
                <div class="mb-4 p-4 bg-primary rounded-lg border border-gray-600">
                    <h4 class="font-semibold mb-2 text-accent">Filtrar Promedios</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="statsFilterType" class="text-sm text-txtsecondary">Tipo de Culto</label>
                            <select id="statsFilterType" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                                <option value="all">Todos</option>
                                <option value="Escuela Dominical">Escuela Dominical</option>
                                <option value="Culto Evangelístico">Culto Evangelístico</option>
                                <option value="Culto de Oración">Culto de Oración</option>
                                <option value="Culto de Dorcas">Culto de Dorcas</option>
                                <option value="Culto de Caballeros">Culto de Caballeros</option>
                                <option value="Culto de Jóvenes">Culto de Jóvenes</option>
                                <option value="Culto Acción de Gracias">Culto Acción de Gracias</option>
                                <option value="Culto música">Culto Música</option>
                                <option value="Culto Campaña">Culto Campaña</option>
                                <option value="Culto Especial">Culto Especial</option>
                                <option value="Culto Misionero (Día)">Culto Misionero (Día)</option>
                                <option value="Culto Misionero (Noche)">Culto Misionero (Noche)</option>
                                <option value="Confraternidad Dorcas (Mitad de Año)">Confraternidad Dorcas (Mitad de Año)</option>
                                <option value="Confraternidad Dorcas (Fin de Año)">Confraternidad Dorcas (Fin de Año)</option>
                                <option value="Confraternidad Jóvenes (Mitad de Año)">Confraternidad Jóvenes (Mitad de Año)</option>
                                <option value="Confraternidad Jóvenes (Fin de Año)">Confraternidad Jóvenes (Fin de Año)</option>
                            </select>
                        </div>
                        <div>
                            <label for="statsFilterStartDate" class="text-sm text-txtsecondary">Desde</label>
                            <input type="date" id="statsFilterStartDate" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                        </div>
                        <div>
                            <label for="statsFilterEndDate" class="text-sm text-txtsecondary">Hasta</label>
                            <input type="date" id="statsFilterEndDate" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="applyStatsFilterBtn" class="flex-1 bg-accent text-primary py-2 px-4 rounded-lg text-sm transition hover:opacity-80">Aplicar Filtro</button>
                        <button id="resetStatsFilterBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm transition">Resetear</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="flex justify-between">
                        <span>Prom. Hermanos:</span>
                        <span id="avgBrothers" class="font-bold">0</span>
                    </p>
                    <p class="flex justify-between">
                        <span>Prom. Hermanas:</span>
                        <span id="avgSisters" class="font-bold">0</span>
                    </p>
                    <p class="flex justify-between">
                        <span>Prom. Visitas:</span>
                        <span id="avgVisitors" class="font-bold">0</span>
                    </p>
                    <p class="flex justify-between">
                        <span>Prom. Niños:</span>
                        <span id="avgChildren" class="font-bold">0</span>
                    </p>
                    <p class="flex justify-between">
                        <span>Prom. Hnos. Visitantes:</span>
                        <span id="avgVisitingBrothers" class="font-bold">0</span>
                    </p>
                    <div class="border-t border-gray-600 pt-2 mt-2">
                        <p class="flex justify-between font-bold text-accent">
                            <span>Promedio General:</span>
                            <span id="avgGrandTotal">0</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="bg-secondary rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-hand-holding-usd text-accent"></i>
                    Ofrendas
                </h3>
                <div class="mb-4 p-4 bg-primary rounded-lg border border-gray-600">
                    <h4 class="font-semibold mb-2 text-accent">Filtrar Ofrendas</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="offeringFilterType" class="text-sm text-txtsecondary">Tipo de Culto</label>
                            <select id="offeringFilterType" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                                <option value="all">Todos</option>
                                <option value="Escuela Dominical">Escuela Dominical</option>
                                <option value="Culto Evangelístico">Culto Evangelístico</option>
                                <option value="Culto de Oración">Culto de Oración</option>
                                <option value="Culto de Dorcas">Culto de Dorcas</option>
                                <option value="Culto de Caballeros">Culto de Caballeros</option>
                                <option value="Culto de Jóvenes">Culto de Jóvenes</option>
                                <option value="Culto Acción de Gracias">Culto Acción de Gracias</option>
                                <option value="Culto música">Culto Música</option>
                                <option value="Culto Campaña">Culto Campaña</option>
                                <option value="Culto Especial">Culto Especial</option>
                                <option value="Culto Misionero (Día)">Culto Misionero (Día)</option>
                                <option value="Culto Misionero (Noche)">Culto Misionero (Noche)</option>
                                <option value="Confraternidad Dorcas (Mitad de Año)">Confraternidad Dorcas (Mitad de Año)</option>
                                <option value="Confraternidad Dorcas (Fin de Año)">Confraternidad Dorcas (Fin de Año)</option>
                                <option value="Confraternidad Jóvenes (Mitad de Año)">Confraternidad Jóvenes (Mitad de Año)</option>
                                <option value="Confraternidad Jóvenes (Fin de Año)">Confraternidad Jóvenes (Fin de Año)</option>
                            </select>
                        </div>
                        <div>
                            <label for="offeringFilterStartDate" class="text-sm text-txtsecondary">Desde</label>
                            <input type="date" id="offeringFilterStartDate" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                        </div>
                        <div>
                            <label for="offeringFilterEndDate" class="text-sm text-txtsecondary">Hasta</label>
                            <input type="date" id="offeringFilterEndDate" class="w-full mt-1 p-2 text-sm rounded-lg bg-secondary border border-gray-500 focus:border-accent focus:ring-2 focus:ring-accent outline-none">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="applyOfferingFilterBtn" class="flex-1 bg-accent text-primary py-2 px-4 rounded-lg text-sm transition hover:opacity-80">Aplicar Filtro</button>
                        <button id="resetOfferingFilterBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg text-sm transition">Resetear</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="flex justify-between">
                        <span>Total Ofrendas:</span>
                        <span id="totalAllOfferings" class="font-bold">$0</span>
                    </p>
                    <p class="text-sm text-txtsecondary">Promedio por culto:</p>
                    <p id="averageOffering" class="text-center text-2xl font-bold text-accent mt-2">$0</p>
                    <p class="text-xs text-center text-txtsecondary italic">(Según filtros aplicados)</p>
                </div>
            </div>
            
            <div class="bg-secondary rounded-lg shadow-xl p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-accent"></i>
                    Distribución por Cultos
                </h3>
                <div class="grid grid-cols-2 gap-4 items-center">
                    <div class="h-40 relative">
                        <canvas id="servicesChart"></canvas>
                    </div>
                    <div id="chartLegend" class="text-xs space-y-1 overflow-y-auto max-h-40 pr-2">
                        <!-- Legend items will be generated here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-secondary rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-exclamation-circle text-5xl text-yellow-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2" id="modalTitle">Confirmación</h3>
                <p class="text-txtsecondary mb-6" id="modalMessage">¿Estás seguro de que deseas continuar?</p>
            </div>
            <div class="flex justify-center gap-4">
                <button id="modalCancelBtn" class="px-6 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 transition">Cancelar</button>
                <button id="modalConfirmBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 hidden z-50">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operación exitosa</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const newBtn = document.getElementById('newBtn');
        const modal = document.getElementById('confirmationModal');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const successToast = document.getElementById('successToast');
        const filterRecords = document.getElementById('filterRecords');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const statsFilterType = document.getElementById('statsFilterType');
        const statsFilterStartDate = document.getElementById('statsFilterStartDate');
        const statsFilterEndDate = document.getElementById('statsFilterEndDate');
        const applyStatsFilterBtn = document.getElementById('applyStatsFilterBtn');
        const resetStatsFilterBtn = document.getElementById('resetStatsFilterBtn');
        const offeringFilterType = document.getElementById('offeringFilterType');
        const offeringFilterStartDate = document.getElementById('offeringFilterStartDate');
        const offeringFilterEndDate = document.getElementById('offeringFilterEndDate');
        const applyOfferingFilterBtn = document.getElementById('applyOfferingFilterBtn');
        const resetOfferingFilterBtn = document.getElementById('resetOfferingFilterBtn');
        
        // Attendance counters
        const brothersInput = document.getElementById('brothers');
        const sistersInput = document.getElementById('sisters');
        const visitorsInput = document.getElementById('visitors');
        const childrenInput = document.getElementById('children');
        const visitingBrothersInput = document.getElementById('visitingBrothers');
        
        // Summary elements
        const totalAttendees = document.getElementById('totalAttendees');
        const totalOffering = document.getElementById('totalOffering');
        
        // Stats elements
        const avgBrothers = document.getElementById('avgBrothers');
        const avgSisters = document.getElementById('avgSisters');
        const avgVisitors = document.getElementById('avgVisitors');
        const avgChildren = document.getElementById('avgChildren');
        const avgVisitingBrothers = document.getElementById('avgVisitingBrothers');
        const avgGrandTotal = document.getElementById('avgGrandTotal');
        const totalAllOfferings = document.getElementById('totalAllOfferings');
        const averageOffering = document.getElementById('averageOffering');
        
        // Records table
        const recordsTable = document.getElementById('recordsTable');
        
        // Chart
        let servicesChart;
        const serviceTypesForChart = [
            'Escuela Dominical', 'Culto Evangelístico', 'Culto de Oración', 'Culto de Dorcas',
            'Culto de Caballeros', 'Culto de Jóvenes', 'Culto Acción de Gracias', 'Culto música',
            'Culto Campaña', 'Culto Especial', 'Culto Misionero (Día)', 'Culto Misionero (Noche)',
            'Confraternidad Dorcas (Mitad de Año)', 'Confraternidad Dorcas (Fin de Año)',
            'Confraternidad Jóvenes (Mitad de Año)', 'Confraternidad Jóvenes (Fin de Año)'
        ];
        const chartColors = [
            '#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899',
            '#14B8A6', '#F97316', '#6366F1', '#06B6D4', '#D946EF', '#22C55E',
            '#84CC16', '#EAB308', '#78716c', '#f43f5e'
        ];
        
        // App state
        let records = JSON.parse(localStorage.getItem('churchAttendanceRecords')) || [];
        let currentAction = '';
        let editingRecordId = null;
        
        // Initialize theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
        
        // Event Listeners
        themeToggle.addEventListener('click', toggleTheme);
        saveBtn.addEventListener('click', () => showConfirmation('guardar esta toma de asistencia'));
        clearBtn.addEventListener('click', () => showConfirmation('limpiar el formulario', 'warning'));
        newBtn.addEventListener('click', startNewRecord);
        modalCancelBtn.addEventListener('click', hideConfirmation);
        modalConfirmBtn.addEventListener('click', confirmAction);
        exportExcelBtn.addEventListener('click', exportToExcel);
        filterRecords.addEventListener('change', filterRecordsTable);
        applyStatsFilterBtn.addEventListener('click', applyStatsFilter);
        resetStatsFilterBtn.addEventListener('click', resetStatsFilter);
        applyOfferingFilterBtn.addEventListener('click', applyOfferingFilter);
        resetOfferingFilterBtn.addEventListener('click', resetOfferingFilter);
        
        // Attendance buttons
        document.querySelectorAll('.increment').forEach(btn => {
            btn.addEventListener('click', () => changeCounter(btn.dataset.target, 1));
        });
        
        document.querySelectorAll('.decrement').forEach(btn => {
            btn.addEventListener('click', () => changeCounter(btn.dataset.target, -1));
        });
        
        // Input changes
        [brothersInput, sistersInput, visitorsInput, childrenInput, visitingBrothersInput].forEach(input => {
            input.addEventListener('change', updateTotalAttendees);
        });
        
        document.getElementById('serviceOffering').addEventListener('input', updateOfferingDisplay);
        
        // Initial setup
        updateStats();
        renderRecordsTable();
        updateTotalAttendees();
        updateOfferingDisplay();
        initializeChart();
        
        // Functions
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        function changeCounter(target, change) {
            const input = document.getElementById(target);
            let value = parseInt(input.value) + change;
            value = Math.max(0, value);
            input.value = value;
            updateTotalAttendees();
        }
        
        function updateTotalAttendees() {
            const brothers = parseInt(brothersInput.value) || 0;
            const sisters = parseInt(sistersInput.value) || 0;
            const visitors = parseInt(visitorsInput.value) || 0;
            const children = parseInt(childrenInput.value) || 0;
            const visitingBrothers = parseInt(visitingBrothersInput.value) || 0;
            
            const total = brothers + sisters + visitors + children + visitingBrothers;
            totalAttendees.textContent = total;
        }
        
        function updateOfferingDisplay() {
            const offering = parseInt(document.getElementById('serviceOffering').value) || 0;
            totalOffering.textContent = `$${offering.toLocaleString()}`;
        }
        
        function showConfirmation(action, type = 'info') {
            currentAction = action;
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            
            if (editingRecordId !== null && action.includes('guardar')) {
                modalTitle.textContent = 'Actualizar Registro';
                modalMessage.textContent = `¿Estás seguro de que deseas actualizar este registro con los datos del formulario?`;
                currentAction = 'actualizar';
            } else if (type === 'warning') {
                modalTitle.textContent = 'Confirmar Acción';
                modalMessage.textContent = `¿Estás seguro de que deseas ${action}? Se perderán los datos no guardados.`;
            } else {
                modalTitle.textContent = 'Guardar Registro';
                modalMessage.textContent = `¿Estás seguro de que deseas ${action}?`;
            }
            
            modal.classList.remove('hidden');
        }
        
        function hideConfirmation() {
            modal.classList.add('hidden');
        }
        
        function confirmAction() {
            hideConfirmation();
            
            if (currentAction.includes('guardar') || currentAction === 'actualizar') {
                saveRecord();
            } else if (currentAction.includes('limpiar')) {
                clearForm();
            } else if (currentAction === 'delete') {
                const idToDelete = parseInt(modalConfirmBtn.dataset.recordId);
                deleteRecord(idToDelete);
            }
        }
        
        function saveRecord() {
            const serviceType = document.getElementById('serviceType').value;
            const serviceDate = document.getElementById('serviceDate').value;
            const serviceLeader = document.getElementById('serviceLeader').value;
            const servicePreacher = document.getElementById('servicePreacher').value;
            const serviceOffering = parseInt(document.getElementById('serviceOffering').value) || 0;
            const brothers = parseInt(brothersInput.value) || 0;
            const sisters = parseInt(sistersInput.value) || 0;
            const visitors = parseInt(visitorsInput.value) || 0;
            const children = parseInt(childrenInput.value) || 0;
            const visitingBrothers = parseInt(visitingBrothersInput.value) || 0;
            
            if (!serviceType || !serviceDate) {
                showToast('Debes completar tipo de servicio y fecha', 'error');
                return;
            }
            
            if (editingRecordId !== null) {
                // Update existing record
                const recordIndex = records.findIndex(r => r.id === editingRecordId);
                if (recordIndex > -1) {
                    records[recordIndex] = {
                        ...records[recordIndex], // Keep original id and timestamp
                        type: serviceType,
                        date: serviceDate,
                        leader: serviceLeader,
                        preacher: servicePreacher,
                        offering: serviceOffering,
                        brothers: brothers,
                        sisters: sisters,
                        visitors: visitors,
                        children: children,
                        visitingBrothers: visitingBrothers,
                    };
                    showToast('Registro actualizado exitosamente');
                }
            } else {
                // Create new record
                const record = {
                    id: Date.now(),
                    type: serviceType,
                    date: serviceDate,
                    leader: serviceLeader,
                    preacher: servicePreacher,
                    offering: serviceOffering,
                    brothers: brothers,
                    sisters: sisters,
                    visitors: visitors,
                    children: children,
                    visitingBrothers: visitingBrothers,
                    timestamp: new Date().toISOString()
                };
                records.push(record);
                showToast('Registro guardado exitosamente');
            }

            localStorage.setItem('churchAttendanceRecords', JSON.stringify(records));
            
            updateAttendanceStats();
            updateOfferingStats();
            renderRecordsTable();
            updateChart();
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('serviceType').value = '';
            document.getElementById('serviceDate').value = '';
            document.getElementById('serviceLeader').value = '';
            document.getElementById('servicePreacher').value = '';
            document.getElementById('serviceOffering').value = '';
            
            brothersInput.value = '0';
            sistersInput.value = '0';
            visitorsInput.value = '0';
            childrenInput.value = '0';
            visitingBrothersInput.value = '0';
            
            editingRecordId = null;
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Guardar`;
            
            updateTotalAttendees();
            updateOfferingDisplay();
        }
        
        function startNewRecord() {
            clearForm();
            document.getElementById('serviceType').focus();
        }
        
        function showToast(message, type = 'success') {
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            
            if (type === 'error') {
                successToast.classList.remove('bg-green-600');
                successToast.classList.add('bg-red-600');
            } else {
                successToast.classList.remove('bg-red-600');
                successToast.classList.add('bg-green-600');
            }
            
            successToast.classList.remove('hidden');
            
            setTimeout(() => {
                successToast.classList.add('hidden');
            }, 3000);
        }
        
        function renderRecordsTable() {
            const filterValue = filterRecords.value;
            let filteredRecords = records;
            
            if (filterValue !== 'all') {
                filteredRecords = records.filter(record => record.type === filterValue);
            }
            
            if (filteredRecords.length === 0) {
                recordsTable.innerHTML = `
                    <tr>
                        <td colspan="12" class="py-4 text-center text-txtsecondary">
                            No hay registros ${filterValue !== 'all' ? 'para este tipo de servicio' : 'aún'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            recordsTable.innerHTML = '';
            
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const total = record.brothers + record.sisters + record.visitors + record.children + (record.visitingBrothers || 0);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700 transition';
                row.innerHTML = `
                    <td class="py-3 px-4">${formatDate(record.date)}</td>
                    <td class="py-3 px-4">${record.type}</td>
                    <td class="py-3 px-4">${record.leader || '-'}</td>
                    <td class="py-3 px-4">${record.preacher || '-'}</td>
                    <td class="py-3 px-4 text-center">${record.brothers}</td>
                    <td class="py-3 px-4 text-center">${record.sisters}</td>
                    <td class="py-3 px-4 text-center">${record.visitors}</td>
                    <td class="py-3 px-4 text-center">${record.children}</td>
                    <td class="py-3 px-4 text-center">${record.visitingBrothers || 0}</td>
                    <td class="py-3 px-4 text-center font-bold">${total}</td>
                    <td class="py-3 px-4 text-center">$${record.offering.toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">
                        <button class="edit-btn p-1 text-blue-400 hover:text-blue-200 transition" data-id="${record.id}" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn p-1 text-red-400 hover:text-red-200 transition" data-id="${record.id}" title="Eliminar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                recordsTable.appendChild(row);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = parseInt(btn.dataset.id);
                    startEditRecord(recordId);
                });
            });

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = parseInt(btn.dataset.id);
                    showDeleteConfirmation(recordId);
                });
            });
        }

        function startEditRecord(recordId) {
            const recordToEdit = records.find(r => r.id === recordId);
            if (!recordToEdit) return;

            editingRecordId = recordId;

            document.getElementById('serviceType').value = recordToEdit.type;
            document.getElementById('serviceDate').value = recordToEdit.date;
            document.getElementById('serviceLeader').value = recordToEdit.leader;
            document.getElementById('servicePreacher').value = recordToEdit.preacher;
            document.getElementById('serviceOffering').value = recordToEdit.offering;
            brothersInput.value = recordToEdit.brothers;
            sistersInput.value = recordToEdit.sisters;
            visitorsInput.value = recordToEdit.visitors;
            childrenInput.value = recordToEdit.children;
            visitingBrothersInput.value = recordToEdit.visitingBrothers || 0;

            updateTotalAttendees();
            updateOfferingDisplay();
            saveBtn.innerHTML = `<i class="fas fa-sync-alt"></i> Actualizar`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showDeleteConfirmation(recordId) {
            currentAction = 'delete';
            
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            
            modalTitle.textContent = 'Eliminar Registro';
            modalMessage.textContent = '¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.';
            
            modalConfirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            modalConfirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            modalConfirmBtn.dataset.recordId = recordId;
            modal.classList.remove('hidden');
        }
        
        function deleteRecord(recordId) {
            records = records.filter(record => record.id !== recordId);
            localStorage.setItem('churchAttendanceRecords', JSON.stringify(records));
            
            updateAttendanceStats();
            updateOfferingStats();
            renderRecordsTable();
            updateChart();
            
            showToast('Registro eliminado exitosamente');
        }
        
        function exportToExcel() {
            const filterValue = filterRecords.value;
            let filteredRecords = records;
            
            if (filterValue !== 'all') {
                filteredRecords = records.filter(record => record.type === filterValue);
            }

            if (filteredRecords.length === 0) {
                showToast('No hay registros para exportar', 'error');
                return;
            }

            // Sort records by date, same as in the table
            const sortedRecords = [...filteredRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

            const headers = [
                "Fecha", "Servicio", "Dirigió", "Predicó", 
                "Hermanos", "Hermanas", "Visitas", "Niños", "Hnos. Visitantes",
                "Total Asistentes", "Ofrenda"
            ];

            const sanitizeCell = (cell) => {
                let cellStr = String(cell === null || cell === undefined ? '' : cell);
                if (cellStr.search(/("|,|\n)/g) >= 0) {
                    cellStr = `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            };

            const rows = sortedRecords.map(record => {
                const total = record.brothers + record.sisters + record.visitors + record.children + (record.visitingBrothers || 0);
                const rowData = [
                    record.date, // YYYY-MM-DD format is good for Excel
                    record.type, record.leader, record.preacher,
                    record.brothers, record.sisters, record.visitors, record.children, (record.visitingBrothers || 0),
                    total, record.offering
                ];
                return rowData.map(sanitizeCell).join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `asistencia_cultos_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Registros exportados a Excel (CSV)');
        }

        function applyStatsFilter() {
            const type = statsFilterType.value;
            const startDate = statsFilterStartDate.value;
            const endDate = statsFilterEndDate.value;

            let filteredRecords = records.filter(record => {
                const recordDate = record.date;
                let typeMatch = true;
                let startDateMatch = true;
                let endDateMatch = true;

                if (type !== 'all') {
                    typeMatch = record.type === type;
                }
                if (startDate) {
                    startDateMatch = recordDate >= startDate;
                }
                if (endDate) {
                    endDateMatch = recordDate <= endDate;
                }

                return typeMatch && startDateMatch && endDateMatch;
            });

            updateAttendanceStats(filteredRecords);
            showToast(`Mostrando promedios para ${filteredRecords.length} registros filtrados.`);
        }

        function resetStatsFilter() {
            statsFilterType.value = 'all';
            statsFilterStartDate.value = '';
            statsFilterEndDate.value = '';
            updateAttendanceStats(); // Use default (all records)
            showToast('Filtros de promedio reseteados.');
        }

        function applyOfferingFilter() {
            const type = offeringFilterType.value;
            const startDate = offeringFilterStartDate.value;
            const endDate = offeringFilterEndDate.value;

            let filteredRecords = records.filter(record => {
                const recordDate = record.date;
                let typeMatch = true;
                let startDateMatch = true;
                let endDateMatch = true;

                if (type !== 'all') {
                    typeMatch = record.type === type;
                }
                if (startDate) {
                    startDateMatch = recordDate >= startDate;
                }
                if (endDate) {
                    endDateMatch = recordDate <= endDate;
                }

                return typeMatch && startDateMatch && endDateMatch;
            });

            updateOfferingStats(filteredRecords);
            showToast(`Mostrando ofrendas para ${filteredRecords.length} registros filtrados.`);
        }

        function resetOfferingFilter() {
            offeringFilterType.value = 'all';
            offeringFilterStartDate.value = '';
            offeringFilterEndDate.value = '';
            updateOfferingStats(); // Use default (all records)
            showToast('Filtros de ofrendas reseteados.');
        }

        function filterRecordsTable() {
            renderRecordsTable();
        }
        
        function formatDate(dateString) {
            // Using 'T00:00:00' or splitting the date avoids timezone issues 
            // where new Date('YYYY-MM-DD') might result in the previous day.
            const date = new Date(dateString + 'T00:00:00');
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        function updateAttendanceStats(recordsToProcess = records) {
            const numRecords = recordsToProcess.length;

            const totalBrothersCount = recordsToProcess.reduce((sum, record) => sum + record.brothers, 0);
            const totalSistersCount = recordsToProcess.reduce((sum, record) => sum + record.sisters, 0);
            const totalVisitorsCount = recordsToProcess.reduce((sum, record) => sum + record.visitors, 0);
            const totalChildrenCount = recordsToProcess.reduce((sum, record) => sum + record.children, 0);
            const totalVisitingBrothersCount = recordsToProcess.reduce((sum, record) => sum + (record.visitingBrothers || 0), 0);
            const totalAllAttendees = totalBrothersCount + totalSistersCount + totalVisitorsCount + totalChildrenCount + totalVisitingBrothersCount;
            
            const avgBrothersCount = numRecords > 0 ? (totalBrothersCount / numRecords).toFixed(1) : '0';
            const avgSistersCount = numRecords > 0 ? (totalSistersCount / numRecords).toFixed(1) : '0';
            const avgVisitorsCount = numRecords > 0 ? (totalVisitorsCount / numRecords).toFixed(1) : '0';
            const avgChildrenCount = numRecords > 0 ? (totalChildrenCount / numRecords).toFixed(1) : '0';
            const avgVisitingBrothersCount = numRecords > 0 ? (totalVisitingBrothersCount / numRecords).toFixed(1) : '0';
            const avgGrandTotalCount = numRecords > 0 ? (totalAllAttendees / numRecords).toFixed(1) : '0';
            
            avgBrothers.textContent = avgBrothersCount;
            avgSisters.textContent = avgSistersCount;
            avgVisitors.textContent = avgVisitorsCount;
            avgChildren.textContent = avgChildrenCount;
            avgVisitingBrothers.textContent = avgVisitingBrothersCount;
            avgGrandTotal.textContent = avgGrandTotalCount;
        }

        function updateOfferingStats(recordsToProcess = records) {
            const numRecords = recordsToProcess.length;
            const totalOfferings = recordsToProcess.reduce((sum, record) => sum + record.offering, 0);
            const averagePerService = numRecords > 0 ? Math.round(totalOfferings / numRecords) : 0;

            totalAllOfferings.textContent = `$${totalOfferings.toLocaleString()}`;
            averageOffering.textContent = `$${averagePerService.toLocaleString()}`;
        }

        function generateChartLegend() {
            const legendContainer = document.getElementById('chartLegend');
            if (!legendContainer) return;

            legendContainer.innerHTML = '';
            const datasets = servicesChart.data.datasets[0];
            const labels = servicesChart.data.labels;

            let hasData = false;
            labels.forEach((label, index) => {
                const count = datasets.data[index];
                if (count > 0) {
                    hasData = true;
                    const color = datasets.backgroundColor[index];
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center gap-2';
                    legendItem.innerHTML = `
                        <span class="w-3 h-3 rounded-sm" style="background-color: ${color}"></span>
                        <span class="flex-1 truncate" title="${label}">${label}</span>
                        <span class="font-bold text-accent">${count}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                }
            });

            if (!hasData) {
                 legendContainer.innerHTML = `<p class="text-txtsecondary text-center italic">No hay datos para el gráfico.</p>`;
            }
        }
        
        function initializeChart() {
            const ctx = document.getElementById('servicesChart').getContext('2d');
            
            const data = serviceTypesForChart.map(type => {
                return records.filter(record => record.type === type).length;
            });
            
            servicesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: serviceTypesForChart,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors,
                        borderWidth: 2,
                        borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#edf2f7'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We use a custom HTML legend
                        }
                    },
                    cutout: '70%'
                }
            });
            generateChartLegend();
        }
        
        function updateChart() {
            const data = serviceTypesForChart.map(type => {
                return records.filter(record => record.type === type).length;
            });
            
            servicesChart.data.datasets[0].data = data;
            servicesChart.update();
            generateChartLegend();
        }
    </script>
</body>
</html>
